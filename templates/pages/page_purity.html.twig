{% extends "base.html.twig" %}

{% set is_content_route = app.request.attributes.get('_route') == 'app_content' %}
{% set analysis_label = is_content_route ? 'Teneur' : 'Pureté' %}
{% set analysis_label_lower = is_content_route ? 'teneur' : 'pureté' %}
{% set analysis_label_plural_lower = is_content_route ? 'teneurs' : 'puretés' %}

{% block title %} {{ analysis_label }} - {{ molecule.label }} {% endblock %}
{% block centerText %} {{ analysis_label }} - {{ molecule.label }} {% endblock %}

{% block body %}
<div class="analysis-page">
    {% include "components/ui/molecule_nav.html.twig" with { molecule: molecule } %}
    <header class="analysis-header container">
        <div class="analysis-header__meta analysis-header__card">
            <small class="analysis-header__label">Nombre total d'échantillons observés :</small>
            <p class="analysis-header__count">{{ results.histo_purity.count }}</p>
            {% include "components/ui/filter_summary.html.twig" with { summary: filters_summary|default([]) } %}
        </div>
        <article class="analysis-header__info analysis-header__card">
            <p>{{ molecule.definition | raw }}</p>
            {% if molecule.wikiUrl %}
                <p>
                    Pour plus d'informations, vous pouvez consulter la
                    <a href="{{ molecule.wikiUrl }}" target="_blank" rel="noreferrer">page Wiki de cette substance</a>.
                </p>
            {% endif %}
        </article>
    </header>
    {% if molecule.label == "3-MMC" %}
        <div class="analysis-header__alert container">
            Point d'attention : de nombreux échantillons vendus comme de la 3-MMC n'en sont pas (cf. le nombre élevé d'échantillons
            dont la {{ analysis_label_lower }} est nulle). Vous pouvez choisir dans les options de ne regarder que les échantillons qui contiennent de la 3-MMC
            d'après l'analyse en laboratoire.
        </div>
    {% endif %}

    <aside
        id="drawerFilters"
        class="drawer"
        role="dialog"
        aria-modal="true"
        aria-labelledby="drawerFiltersTitle"
        aria-hidden="true"
    >
        <div class="drawer__panel">
            <div class="drawer__handle" aria-hidden="true"></div>
            <div class="drawer__inner">
                <div class="drawer__header">
                    <h3 id="drawerFiltersTitle">Options de visualisation</h3>
                    <button class="btn btn--ghost drawer__close" type="button" aria-label="Fermer les options" data-drawer-close>✕</button>
                </div>
                <div class="drawer__body">
                    {% include "components/forms/form_purity.html.twig" %}
                </div>
            </div>
        </div>
    </aside>

    {% include "components/ui/drawer_trigger.html.twig" %}

    {% include "components/ui/grid_layout_controls.html.twig" %}

    <section class="analysis-grid container">
        {% set histogram_desc %}
            <p>
                Commençons par regarder le nombre d'échantillons en fonction de leur {{ analysis_label_lower }}.
                Les analyses présentent la {{ analysis_label_lower }} de deux façons différentes : équivalent base et équivalent chlorhydrate.
                Les produits psychoactifs sont souvent vendus sous forme de poudre ou de cristal et ne contiennent pas uniquement
                la substance psychoactive (cocaïne, héroïne, MDMA, ...). Le pourcentage d'une substance en équivalent base,
                c'est le pourcentage de la dite molécule dans la poudre. Nous avons choisi de présenter le pourcentage en équivalent base
                car c'est celui directement mesuré par le laboratoire.
            </p>
            <p>
                La {{ analysis_label_lower }} maximale (en masse) n'est pas 100% (car la poudre ne peut pas contenir que la molécule psychoactive) mais dépend
                de la molécule considérée et est représentée par la barre verticale rouge en pointillé.
                Certains échantillons se situent au-delà de cette limite car les résultats d'analyse sont donnés avec une incertitude de +/- 10%.
                Pour plus d'information, vous pouvez consulter la
                <a href="https://www.psychoactif.org/forum/viewtopic.php?id=79748" target="_blank">F.A.Q. sur l'analyse de drogues à distance.</a>
            </p>
        {% endset %}

        {% embed "components/ui/analysis_card.html.twig" with {
            title: "Histogramme de la " ~ analysis_label_lower,
            description: histogram_desc,
            embed_chart: 'histogram'
        } %}
            {% block body %}
                {% include "components/charts/bar_y_chart.html.twig" with { id:"bar_chart", chart_data: results.histo_purity | json_encode, unit:unit} %}
            {% endblock %}
        {% endembed %}

        {% set purity_mean_desc %}
            <p>
                Visualisation de l'évolution de la moyenne de {{ analysis_label_lower }} et de la zone représentant +/- 1 écart-type autour de cette moyenne.
                Calculée sur une fenêtre glissante de Δ jours autour de chaque échantillon (actuellement Δ = {{ delta }} jours).
            </p>
        {% endset %}

        {% embed "components/ui/analysis_card.html.twig" with {
            title: "Évolution temporelle – Moyennes et écarts type",
            description: purity_mean_desc,
            embed_chart: 'temporal_mean'
        } %}
            {% block body %}
                {% include "components/charts/line_chart.html.twig" with {id:"line_1", chart_data: results.temporal_purity_avg | json_encode, is_stacked:'false'} %}
            {% endblock %}
        {% endembed %}

        {% set purity_median_desc %}
            <p>
                Visualisation de la médiane de {{ analysis_label_lower }} au fil du temps, accompagnée d'une zone grisée allant du premier au troisième quartile.
                Basée sur la même fenêtre glissante de Δ jours (actuellement Δ = {{ delta }} jours).
            </p>
        {% endset %}

        {% embed "components/ui/analysis_card.html.twig" with {
            title: "Évolution temporelle – Médianes et quartiles",
            description: purity_median_desc,
            embed_chart: 'temporal_median'
        } %}
            {% block body %}
                {% include "components/charts/line_chart.html.twig" with {id:"line_2", chart_data: results.temporal_purity_med | json_encode, is_stacked:'false'} %}
            {% endblock %}
        {% endembed %}

        {% if results.supply_reg_purity %}
            {% set supply_desc %}
                <p>
                    Intéressons-nous ensuite à la dépendance de la {{ analysis_label_lower }} au mode d'approvisionnement. Pour cela, nous régressons
                    la {{ analysis_label_lower }} sur le mode d'approvisionnement. On choisit le mode privilégié (Deep web / dark web)
                    et on regarde si l'écart à ce premier mode est statistiquement significatif. Cette significativité est symbolisée
                    par les "*" dans la colonne écart. "***" si la probabilité que l'écart soit dû au hasard est < 1%, "**" si elle est < 5%
                    et "*" si elle est < 10%. Cette probabilité se nomme la <a href="https://fr.wikipedia.org/wiki/Valeur_p" target="_blank">p-value</a>.
                </p>
                <p>
                    On peut aussi, de façon plus approximative, comparer l'<a href="https://fr.wikipedia.org/wiki/Erreur_type" target="_blank">erreur standard</a> à son coefficient respectif :
                    si l'écart est moins que le double de l'erreur standard, alors on ne peut pas détecter si l'écart observé est dû au hasard ou non.
                    Enfin, nous présentons aussi le coefficient R² pour quantifier à quel point le modèle de régression explique les données observées.
                </p>
            {% endset %}

            {% embed "components/ui/analysis_card.html.twig" with {
                title: "Influence du mode d'approvisionnement",
                description: supply_desc
            } %}
                {% block body %}
                    {% include "components/charts/regression_table.html.twig" with {
                        id:"supply_regression",
                        table_data:results.supply_reg_purity| json_encode,
                        analysis_label: analysis_label
                    } %}
                {% endblock %}
            {% endembed %}
        {% endif %}

        {% if results.geo_purity %}
            {% set map_desc %}
                <p>
                    Désormais, regardons la géographie de la {{ analysis_label_lower }}. Sur la carte suivante est présentée la {{ analysis_label_lower }} moyenne
                    par région parmi les échantillons qui ne proviennent pas du dark net.
                    Nous retirons ces échantillons car le marché se passe à l'échelle internationale.
                </p>
                <div class="alert-panel">
                    Point d'attention : la représentation sous forme de carte a le bénéfice d'être très visuelle, mais elle possède d'importants défauts.
                    Il est difficile de savoir si les différences de {{ analysis_label_plural_lower }} moyennes entre les régions sont significatives ou le simple fruit du hasard.
                    Des comportements de consommation différents peuvent également créer les différences observées. Ainsi, nous conseillons de regarder le tableau qui suit.
                </div>
            {% endset %}

            {% embed "components/ui/analysis_card.html.twig" with {
                title: "Carte de la " ~ analysis_label_lower ~ " moyenne par région",
                description: map_desc,
                embed_chart: 'map'
            } %}
                {% block body %}
                    {{ render_map('map_chart_prop', results.geo_purity, options:{
                            'start_hsl': [120, 60, 85],
                            'end_hsl': [200, 100, 30],
                    } ) }}
                {% endblock %}
            {% endembed %}
        {% endif %}

        {% if results.geo_reg_purity %}
            {% set geo_reg_desc %}
                <p>
                    Demandons-nous comment analyser la carte de France présentant la {{ analysis_label_lower }} par région.
                    Pour prendre en compte les différences de modes d'approvisionnement ou de dates d'achat,
                    nous réalisons une <a href="https://en.wikipedia.org/wiki/Fixed_effects_model" target="_blank">régression à effets fixes</a>
                    en choisissant comme effets fixes le mode d'approvisionnement et le bimestre d'achat. Nous comparons uniquement les variations de qualité à l’intérieur
                    d’un même mode et d’un même bimestre, en neutralisant les différences moyennes entre groupes.
                </p>
            {% endset %}

            {% embed "components/ui/analysis_card.html.twig" with {
                title: "Analyse de la carte de la " ~ analysis_label_lower,
                description: geo_reg_desc
            } %}
                {% block body %}
                    {% include "components/charts/regression_table_fe.html.twig" with {id:"region_regression", table_data:results.geo_reg_purity | json_encode} %}
                {% endblock %}
            {% endembed %}
        {% endif %}
    </section>
</div>

<script>
document.addEventListener('psychotopia:tab-changed', (event) => {
    const panelId = event.detail.panelId;
    if (panelId === 'tab-purity-mean' && window.line_1_chart) {
        setTimeout(() => window.line_1_chart.resize(), 100);
    }
    if (panelId === 'tab-purity-median' && window.line_2_chart) {
        setTimeout(() => window.line_2_chart.resize(), 100);
    }
});
</script>
{% endblock %}
