<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Analyses statistiques détaillées sur la consommation de drogue en France : pureté, coupe, tendances et comparaisons régionales.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    
    {% block stylesheets %}
        {{ encore_entry_link_tags('app') }}
    {% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/patternomaly@1.3.0/dist/patternomaly.min.js"></script>

    {% block javascripts %}
        {{ encore_entry_script_tags('chart-defaults', attributes={ defer: false }) }}
        {{ encore_entry_script_tags('app') }}
    {% endblock %}
 
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

</head>
{% set _supported_themes = ['navy', 'nocturne', 'neon'] %}
{% set _theme = app.request.query.get('theme') %}
{% if _theme not in _supported_themes %}
    {% set _theme = 'navy' %}
{% endif %}
{% set _embed_molecule_slug = molecule is defined ? molecule.slug : null %}
<body
    data-theme="{{ _theme }}"
    data-embed-route="{{ path('app_embedded') }}"
    {% if _embed_molecule_slug %}
        data-embed-molecule="{{ _embed_molecule_slug }}"
    {% endif %}
>
  
    {% include "nav.html.twig" %}

    <main id="content">
        {% block body %}{% endblock %}
    </main>

    {% include 'footer.html.twig' %}

    {% include 'components/ui/analysis_card_modal.html.twig' %}

    <script>
        (function() {
            const storageKey = 'psychotopia-theme';
            const readStoredTheme = () => {
                try {
                    return window.localStorage.getItem(storageKey);
                } catch (error) {
                    return null;
                }
            };
            const persistTheme = (theme) => {
                try {
                    window.localStorage.setItem(storageKey, theme);
                } catch (error) {
                    /* ignore persistence errors */
                }
            };
            const supportedThemes = {{ _supported_themes|json_encode|raw }};
            const body = document.body;
            const savedTheme = readStoredTheme();

            if (savedTheme && supportedThemes.includes(savedTheme)) {
                body.dataset.theme = savedTheme;
            }

            const updatePickers = () => {
                const activeTheme = body.dataset.theme || 'navy';
                document.querySelectorAll('[data-theme-picker]').forEach((picker) => {
                    picker.value = activeTheme;
                });
            };

            const applyTheme = (theme) => {
                if (!supportedThemes.includes(theme)) {
                    return;
                }
                body.dataset.theme = theme;
                persistTheme(theme);
                updatePickers();
            };

            document.addEventListener('change', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLSelectElement)) {
                    return;
                }
                if (!target.matches('[data-theme-picker]')) {
                    return;
                }
                applyTheme(target.value);
            });

            updatePickers();
        })();
    </script>
    {% if matomo.enabled and matomo.baseUrl and matomo.siteId %}
        {% set _matomo_base = matomo.baseUrl %}
        {% if not _matomo_base ends with '/' %}
            {% set _matomo_base = _matomo_base ~ '/' %}
        {% endif %}
        <script>
            var _paq = window._paq = window._paq || [];
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function() {
                var u={{ _matomo_base|json_encode|raw }};
                _paq.push(['setTrackerUrl', u + 'matomo.php']);
                _paq.push(['setSiteId', {{ matomo.siteId|json_encode|raw }}]);
                var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
                g.async = true; g.src = u + 'matomo.js'; s.parentNode.insertBefore(g, s);
            })();
        </script>
    {% endif %}
</body>
</html>
