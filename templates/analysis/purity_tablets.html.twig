{% extends "base.html.twig" %}

{% block title %} Pureté comprimé - {{ molecule_name }} {% endblock %}
{% block centerText %} Pureté comprimé - {{ molecule_name }} {% endblock %}

{% block body %}

<div class="d-flex align-items-center gap-3 m-3">
    
    <!-- Infos sur le nombre total d'observations -->
    <div>
        <small>Nombre total d'échantillons observés :</small>
        <p class="display-6 mb-0">{{ results.histo_purity.count }}</p>
    </div>

    <!-- Bouton pour ouvrir le formulaire -->
    <button class="btn btn-primary flex-shrink-0" style="width: 200px;" 
            type="button" data-bs-toggle="offcanvas" data-bs-target="#formOffcanvas" 
            aria-controls="formOffcanvas">
        Options de visualisation
    </button>
</div>

<!-- Offcanvas gauche -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="formOffcanvas" aria-labelledby="formOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="formOffcanvasLabel">Formulaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
    <div class="offcanvas-body">
        {% include "components/form_purity.html.twig" %}
    </div>
</div>

<div class="info-box">
    <p>
        {{ presentation | raw }}
        Pour plus d'informations, vous pouvez regarder la 
        <a href="{{ url_wiki }}" target="_blank">page Wiki de cette substance</a>.
    </p>
</div>


<div class="container py-3">
    <div class="masonry-grid">

        <!-- Carte 1 : Histogramme de pureté -->
        <div class="card text-center">
            <div class="card-header">
                Histogramme de la pureté
            </div>
            <div class="card-body">
                {% include "components/bar_y_chart.html.twig" with { id:"bar_chart", chart_data: results.histo_purity | json_encode, unit:unit} %}
                <p>
                    Commençons par regarder le nombre d'échantillons en fonction de leur pureté.
                    Les analyses présentent la pureté de deux façons différentes : équivalent base et équivalent chlorhydrate.
                    Les produits psychoactifs sont souvent vendus sous forme de poudre ou de cristal et ne contiennent pas uniquement
                    la substance psychoactive (cocaïne, héroïne, MDMA, ...). Le pourcentage d'une substance en équivalent base, 
                    c'est le pourcentage de la dite molécule dans la poudre. Nous avons choisi de présenter le pourcentage en équivalent base 
                    car c'est celui directement mesuré par le laboratoire.
                    La pureté maximale (en masse) n'est pas 100% (car la poudre ne peut pas contenir que la molécule psychoactive) mais dépend 
                    de la molécule considérée et est représentée par la barre verticale rouge en pointillé.
                    Certains échantillons se situent au-delà de cette limite car les résultats d'analyse sont donnés avec une incertitude de +/- 10%.
                    Pour plus d'information, vous pouvez consultez la <a href="https://www.psychoactif.org/forum/viewtopic.php?id=79748" target="_blank">F.A.Q.</a>
                    sur l'analyse de drogues à distance.
                </p>
            </div>
        </div>

        <!-- Carte 2 : Évolution temporelle -->
        <div class="card text-center">
            <div class="card-header">
                Évolution temporelle de la pureté
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="chart1-tab" data-bs-toggle="tab" data-bs-target="#chart1" type="button" role="tab">
                            Moyenne et écarts type
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chart2-tab" data-bs-toggle="tab" data-bs-target="#chart2" type="button" role="tab">
                            Médianes et quartiles
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="chart1" role="tabpanel">
                        <p>La ligne bleue représente la moyenne et la zone grisée est l'espace autour de la moyenne à +/- 1 écart-type.</p>
                        {% include "components/line_chart.html.twig" with {id:"line_1", chart_data: results.temporal_purity_avg | json_encode, is_stacked:'false'} %}
                    </div>
                    <div class="tab-pane fade" id="chart2" role="tabpanel">
                        <p>La ligne bleue représente la médiane, la zone grisée s'étend du premier quartile au troisième quartile.</p>
                        {% include "components/line_chart.html.twig" with {id:"line_2", chart_data: results.temporal_purity_med | json_encode, is_stacked:'false'} %}
                    </div>
                </div>
                <p>
                    Jetons ensuite un coup d'œil à l'évolution temporelle de la pureté. Deux choix s'offrent à vous, vous pouvez soit visualiser
                    l'évolution de la moyenne et de l'écart-type de la distribution des échantillons, soit l'évolution de la médiane,
                    ainsi que le premier et troisième quartile. Chacune des grandeurs est calculée sur une fenêtre glissante de Δ
                    jours autour de chaque échantillon reçu (actuellement Δ = {{delta}} jours). Vous pouvez paramétrer la valeur de Δ 
                    dans les "Options de visualisation".
                </p>
            </div>
        </div>
        
        <!-- MDMA comprime scatter-and-line plot -->
        <div class="card text-center">
            <div class="card-header">
                Quantité de substance active VS Masse des comprimés
            </div>
            <div class="card-body">
                {% include "components/scatter_line_chart.html.twig" with { id:"scatter_mdma_comprime", chart_data: results.mass_reg_purity | json_encode } %}
            </div>
            <p>
                Ce nuage de points représente la relation entre la masse des comprimés envoyés (en milligrammes) 
                et la quantité de substance psychoactive effectivement mesurée en laboratoire (en milligrammes). Chaque point correspond à un échantillon individuel. 
                L’objectif est d’évaluer la cohérence entre la masse du comprimé et sa teneur réelle en substance active. 
                La droite rouge représente le meilleur modèle linéaire pour lier la teneur en substance psychoactive au poids des comprimés.
                La zone grisée décrit un intervalle de confiance à 95% sur ce modèle. 
                <br>
                On peut interpréter le graphe comme suit : si la masse de substance active
                était une fonction linéaire de la masse des comprimés, alors la droite rouge est le meilleur modèle en fonction des échantillons et
                la zone grisée représenterait l'intervalle de confiance à 95% sur ce modèle.
                <br>
                Dans les faits, la quantité de substance dans un comprimé ne dépend évidemment pas que de la masse de celui-ci donc la droite rouge n'est qu'une 
                approximation de la relation entre ces deux grandeurs. Elle peut être utilisée pour estimer (grossièrement) la quantité de substance active dans un nouveau comprimé
                si on connait uniquement la masse du comprimé. La zone grisée permet alors d'estimer l'erreur commise sur la prédiction donnée par la ligne rouge.
            </p>
        </div>
    </div>
</div>

<script>
document.addEventListener('shown.bs.tab', function (event) {
    setTimeout(() => {
        if (window.line_1_chart && event.target.id === 'chart1-tab') {
            window.line_1_chart.resize();
        } else if (window.line_2_chart && event.target.id === 'chart2-tab') {
            window.line_2_chart.resize();
        }
    }, 100);
});
</script>

{% endblock %}
