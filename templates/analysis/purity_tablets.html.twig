{% extends "base.html.twig" %}

{% block title %} Pureté comprimé - {{ molecule.label }} {% endblock %}
{% block centerText %} Pureté comprimé - {{ molecule.label }} {% endblock %}

{% block body %}
<div class="analysis-page">
    <header class="analysis-header container">
        <div class="analysis-header__meta">
            <small class="analysis-header__label">Nombre total d'échantillons observés :</small>
            <p class="analysis-header__count">{{ results.histo_purity.count }}</p>
        </div>
    </header>

    <aside
        id="drawerFilters"
        class="drawer"
        role="dialog"
        aria-modal="true"
        aria-labelledby="drawerFiltersTitle"
        aria-hidden="true"
    >
        <div class="drawer__panel">
            <div class="drawer__handle" aria-hidden="true"></div>
            <div class="drawer__inner">
                <div class="drawer__header">
                    <h3 id="drawerFiltersTitle">Options de visualisation</h3>
                    <button class="btn btn--ghost drawer__close" type="button" aria-label="Fermer les options" data-drawer-close>✕</button>
                </div>
                <div class="drawer__body">
                    {% include "components/form_purity.html.twig" %}
                </div>
            </div>
        </div>
    </aside>

    {% include "components/drawer_trigger.html.twig" %}

    <section class="info-panel container">
        <p>
            {{ molecule.definition | raw }}
            Pour plus d'informations, vous pouvez regarder la
            <a href="{{ molecule.wikiUrl }}" target="_blank">page Wiki de cette substance</a>.
        </p>
    </section>

    <section class="analysis-grid container">
        <article class="analysis-card">
            <header class="analysis-card__head">Histogramme de la pureté</header>
            <div class="analysis-card__body">
                {% include "components/bar_y_chart.html.twig" with { id:"bar_chart", chart_data: results.histo_purity | json_encode, unit:unit} %}
                <p>
                    Commençons par regarder le nombre d'échantillons en fonction de leur pureté.
                    Les analyses présentent la pureté de deux façons différentes : équivalent base et équivalent chlorhydrate.
                    Nous présentons le pourcentage en équivalent base car c'est celui directement mesuré par le laboratoire.
                </p>
                <p>
                    La pureté maximale n'est pas 100% mais dépend de la molécule considérée et est représentée par la barre verticale rouge en pointillé.
                    Certains échantillons peuvent dépasser cette limite car les résultats sont donnés avec une incertitude de +/- 10%.
                </p>
            </div>
        </article>

        <article class="analysis-card">
            <header class="analysis-card__head">Évolution temporelle de la pureté</header>
            <div class="analysis-card__body">
                <div class="tabs" data-tab-group="tablets-{{ molecule.slug }}">
                    <div class="tabs__list" role="tablist">
                        <button
                            class="tabs__button is-active"
                            type="button"
                            role="tab"
                            aria-controls="tab-tablets-mean"
                            aria-selected="true"
                            data-tab-target="#tab-tablets-mean"
                        >
                            Moyenne et écarts type
                        </button>
                        <button
                            class="tabs__button"
                            type="button"
                            role="tab"
                            aria-controls="tab-tablets-median"
                            aria-selected="false"
                            data-tab-target="#tab-tablets-median"
                        >
                            Médianes et quartiles
                        </button>
                    </div>
                    <div class="tabs__panel is-active" id="tab-tablets-mean" role="tabpanel" data-tab-panel>
                        <p>La ligne bleue représente la moyenne et la zone grisée est l'espace autour de la moyenne à +/- 1 écart-type.</p>
                        {% include "components/line_chart.html.twig" with {id:"line_1", chart_data: results.temporal_purity_avg | json_encode, is_stacked:'false'} %}
                    </div>
                    <div class="tabs__panel" id="tab-tablets-median" role="tabpanel" data-tab-panel>
                        <p>La ligne bleue représente la médiane, la zone grisée s'étend du premier quartile au troisième quartile.</p>
                        {% include "components/line_chart.html.twig" with {id:"line_2", chart_data: results.temporal_purity_med | json_encode, is_stacked:'false'} %}
                    </div>
                </div>
                <p>
                    Vous pouvez visualiser l'évolution de la moyenne et de l'écart-type, ou bien celle de la médiane et des quartiles,
                    sur une fenêtre glissante de Δ jours (actuellement Δ = {{ delta }}). Ajustez Δ dans les options de visualisation.
                </p>
            </div>
        </article>

        <article class="analysis-card">
            <header class="analysis-card__head">Quantité de substance active vs masse des comprimés</header>
            <div class="analysis-card__body">
                {% include "components/scatter_line_chart.html.twig" with { id:"scatter_mdma_comprime", chart_data: results.mass_reg_purity | json_encode } %}
                <p>
                    Ce nuage de points représente la relation entre la masse des comprimés envoyés (en milligrammes)
                    et la quantité de substance psychoactive mesurée en laboratoire. Chaque point correspond à un échantillon individuel.
                </p>
                <p>
                    La droite rouge représente le meilleur modèle linéaire pour lier la teneur en substance psychoactive au poids des comprimés.
                    La zone grisée décrit un intervalle de confiance à 95%. Elle peut être utilisée pour estimer l'erreur commise
                    lors de la prédiction de la quantité de substance active lorsque seule la masse du comprimé est connue.
                </p>
            </div>
        </article>
    </section>
</div>

<script>
document.addEventListener('psychotopia:tab-changed', (event) => {
    const panelId = event.detail.panelId;
    if (panelId === 'tab-tablets-mean' && window.line_1_chart) {
        setTimeout(() => window.line_1_chart.resize(), 100);
    }
    if (panelId === 'tab-tablets-median' && window.line_2_chart) {
        setTimeout(() => window.line_2_chart.resize(), 100);
    }
});
</script>
{% endblock %}
